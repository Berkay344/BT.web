<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>ESOS Fastfood Sipariş</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f8f9fa;
      color: #333;
    }
    .navbar {
      background-color: #e53935;
      padding: 15px 20px;
      color: white;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 999;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .container {
      max-width: 600px;
      margin: 30px auto;
      background: #fff;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .logo { text-align: center; margin-bottom: 20px; }
    .logo img { max-width: 150px; }
    h1 {
      text-align: center;
      font-size: 20px;
      color: #e53935;
      margin-bottom: 20px;
    }
    .form-group { margin-bottom: 20px; }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #f9f9f9;
      font-size: 15px;
    }
    input:focus {
      outline: none;
      background-color: #fff;
      border-color: #e53935;
    }
    button {
      width: 100%;
      background-color: #e53935;
      color: white;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover { background-color: #c62828; }
    .menu-item {
      background-color: #f3f4f6;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #e1e1e1;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .menu-item input[type="checkbox"] {
      transform: scale(1.2);
      margin-right: 10px;
    }
    .menu-item input[type="number"] {
      width: 60px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .order-box {
      background-color: #fefefe;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 20px;
      line-height: 1.6;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-top: 20px;
    }

  .esos-popup {
    border: 2px solid red !important;
    border-radius: 12px !important;
    padding: 10px;
  }

  .esos-confirm-btn {
    background-color: green !important;
    color: #fff !important;
    font-weight: bold !important;
    border-radius: 8px !important;
    font-size: 16px !important;
    padding: 10px 20px !important;
    border: none !important;
  }

  .esos-confirm-btn:hover {
    background-color: green !important;
  }

  .esos-cancel-btn {
    background-color: red !important;
    color: white !important;
    font-weight: bold !important;
    border-radius: 8px !important;
    font-size: 16px !important;
    padding: 10px 20px !important;
    border: none !important;
  }

  .esos-cancel-btn:hover {
    background-color: #d6d6d6 !important;
  }
.sepet-kapat-btn {
  background-color: #e53935 !important; /* kırmızı */
  color: #fff !important;
  font-weight: bold !important;
  border-radius: 8px !important;
  font-size: 16px !important;
  padding: 10px 20px !important;
  border: none !important;
}

.menu-box {
  background: #ffffff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 15px rgba(0,0,0,0.1);
  max-width: 450px;
  margin: 20px auto;
  font-family: 'Poppins', sans-serif;
}
.menu-box h3 {
  margin-bottom: 15px;
  color: #2c3e50;
  font-size: 20px;
}
.menu-box ul {
  list-style: none;
  padding-left: 0;
}
.menu-box li {
  margin-bottom: 10px;
  font-size: 16px;
  color: #34495e;
  display: flex;
  align-items: center;
  gap: 8px;
}
.menu-box p {
  color: #888;
  font-size: 15px;
}

/* Sayfa genelinde taşmayı engelle */
body, html {
  margin: 0;
  padding: 0;
  overflow-x: hidden;
  max-width: 100%;
}

/* Menü kutusunun taşmaması için */
.menu-box {
  box-sizing: border-box;
  max-width: 100%;
  word-wrap: break-word;
}

/* Liste ve içeriklerde genişlik aşımı varsa engelle */
ul, li {
  max-width: 100%;
  overflow-wrap: break-word;
}

html, body {
  margin: 0;
  padding: 0;
  overflow-x: hidden;  /* ❌ Sağa sola scroll'u engeller */
  max-width: 100vw;
  touch-action: pan-y; /* Sadece yukarı-aşağı kaydırma */
}

.container, .menu-box, .site-wrapper {
  max-width: 100%;
  box-sizing: border-box;
  overflow-x: hidden;
}

body {
  touch-action: manipulation;
}

  </style>
</head>
<body>
  <div class="navbar" style="display: flex; justify-content: space-between; align-items: center;">
  <span><i class="fas fa-burger"></i> ESOS Sipariş</span>
  <div style="position: relative;">
  <i class="fas fa-shopping-bag" onclick="showCart()" style="cursor: pointer; color: white; font-size: 20px;"></i>
  <span id="cart-count" style="
    position: absolute;
    top: -8px;
    right: -8px;
    background-color: #2196f3;
    color: white;
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 50%;
    display: none;
  ">0</span>
</div>
</div>
  <div id="site-acik" style="display:none;">
  <!-- Sipariş alanı, menü vs -->
</div>

<div id="site-kapali" style="display:none;">
  <!-- Sistem kapalı yazısı (gizli çünkü SweetAlert çıkıyor zaten) -->
</div>
  <div class="container">
    <div class="logo">
      <img src="https://i.hizliresim.com/7sp9pd6.png" alt="ESOS Logo">
    </div>

    <h1><i class="fas fa-utensils"></i> Sipariş Formu</h1>

    <div class="form-group">
      <label><i class="fas fa-user"></i> Ad Soyad</label>
      <input type="text" id="name" placeholder="Adınızı girin">
    </div>

    <div class="form-group">
      <label><i class="fas fa-phone"></i> Telefon</label>
      <input type="text" id="phone" placeholder="Telefon numaranız">
    </div>

    <div class="form-group">
      <label><i class="fas fa-comment-dots"></i> Not (isteğe bağlı)</label>
      <input type="text" id="note" placeholder="Acısız olsun, bol kaşarlı...">
    </div>

    <div id="gununMenusu" class="menu-box">
  <p>Yükleniyor...</p>
</div>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <div class="form-group">
      <label><i class="fas fa-list"></i> Menü Seçimi</label>
      <div id="menu-list">Yükleniyor...</div>
    </div>

    <button onclick="submitOrder(event)"><i class="fas fa-paper-plane"></i> Siparişi Gönder</button>

    <h1 style="margin-top: 40px;"><i class="fas fa-box-open"></i> Sipariş Durumu</h1>
    <div id="order-status">
  <span style="color:red;">🔄 Hazırlanıyor...</span>
  <button onclick="cancelOrder(orderId)" style="margin-left: 10px; color: white; background: #c0392b; border: none; padding: 5px 10px; border-radius: 5px;">❌ İptal Et</button>
</div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCDNbgKzJdBKEZUnWH09Az6ZCwUefWJXhY",
      authDomain: "onlinesiparis-2cf91.firebaseapp.com",
      projectId: "onlinesiparis-2cf91",
      storageBucket: "onlinesiparis-2cf91.appspot.com",
      messagingSenderId: "366801664755",
      appId: "1:366801664755:web:57b577f1943ebdf1ab8c85",
      databaseURL: "https://onlinesiparis-2cf91-default-rtdb.europe-west1.firebasedatabase.app"
    };

    firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let aktifUyari = null;

db.ref("sistemDurumu").on("value", (snapshot) => {
  const durum = snapshot.val()?.durum || "acik";
  const neden = snapshot.val()?.neden || "normal";

  if (durum === "kapali") {
    let mesaj = "", ikon = "info";

    if (neden === "normal") {
      mesaj = "Sistem şu anda <strong>bakımdadır</strong>. Lütfen daha sonra tekrar deneyin.";
      ikon = "warning";
    } else if (neden === "calisma") {
      mesaj = "Şu anda <strong>çalışma saatleri dışında</strong> olduğumuz için sistem kapalıdır.<br><br><strong>Çalışma Saatleri:</strong> 08:00 - 19:30";
      ikon = "info";
    } else if (neden === "carsamba") {
      mesaj = "📅 <strong>Çarşamba günleri</strong> kapalıyız. Lütfen diğer günlerde tekrar gelin.";
      ikon = "error";
    }

    if (aktifUyari !== neden) {
      aktifUyari = neden;

      Swal.fire({
        icon: ikon,
        title: "🔒 Sipariş Alınamıyor",
        html: mesaj,
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false
      });
    }

    // Sayfa içeriğini gizle
    document.getElementById("site-acik").style.display = "none";
    document.getElementById("site-kapali").style.display = "block";

  } else {
    aktifUyari = null;

    // Sayfa içeriğini göster
    document.getElementById("site-acik").style.display = "block";
    document.getElementById("site-kapali").style.display = "none";
  }
});

    // Menü yükle
    const menuList = document.getElementById('menu-list');
    db.ref("menu").on("value", function(snapshot) {
      menuList.innerHTML = "";
      if (!snapshot.exists()) {
        menuList.innerHTML = "<em>Menü bulunamadı.</em>";
        return;
      }
      snapshot.forEach((child) => {
        const item = child.val();
        const key = child.key;
        const div = document.createElement("div");
        div.className = "menu-item";
        div.innerHTML = `
          <input type="checkbox" id="item-${key}" value="${item.name}" data-price="${item.price}">
          <label for="item-${key}">${item.name} - ₺${item.price}</label>
          <input type="number" id="qty-${key}" min="1" value="1">
        `;
        menuList.appendChild(div);
      });
    });

function updateCartCount() {
  const checkedBoxes = document.querySelectorAll("input[type=checkbox]:checked");
  let totalItems = 0;

  checkedBoxes.forEach((checkbox) => {
    const key = checkbox.id.replace("item-", "");
    const qty = parseInt(document.getElementById("qty-" + key).value || "1");
    totalItems += qty;
  });

  const badge = document.getElementById("cart-count");

  if (totalItems > 0) {
    badge.style.display = "inline-block";
    badge.innerText = totalItems;
  } else {
    badge.style.display = "none";
  }
}

document.addEventListener("change", function(e) {
  if (e.target.matches('input[type=checkbox]') || e.target.matches('input[type=number]')) {
    updateCartCount();
  }
});

    // Sipariş gönder
    function submitOrder() {
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const note = document.getElementById("note").value.trim();
  if (!/^\d{10,15}$/.test(phone)) {
  Swal.fire({
    icon: "warning",
    title: "Geçersiz Numara",
    text: "Lütfen geçerli bir telefon numarası girin (sadece rakam, boşluksuz)."
  });
  return;
}
  if (!name || !phone) {
    Swal.fire({
      icon: "warning",
      title: '<i class="fas fa-exclamation-triangle" style="color:orange;"></i> Eksik Bilgi',
      text: "Lütfen ad ve telefon numaranızı girin."
    });
    return;
  }

  const selectedItems = [];
  document.querySelectorAll("input[type=checkbox]:checked").forEach((checkbox) => {
    const key = checkbox.id.replace("item-", "");
    const itemName = checkbox.value;
    const itemPrice = parseFloat(checkbox.dataset.price);
    const quantity = parseInt(document.getElementById("qty-" + key).value || "1");
    selectedItems.push({ name: itemName, price: itemPrice, quantity });
  });

  if (selectedItems.length === 0) {
    Swal.fire({
      icon: "info",
      title: '<i class="fas fa-info-circle" style="color:#3498db;"></i> Ürün Seçilmedi',
      text: "Lütfen en az bir ürün seçin."
    });
    return;
  }

  let itemsText = "";
  let total = 0;
  selectedItems.forEach(item => {
    const subtotal = item.price * item.quantity;
    total += subtotal;
    itemsText += `<i class="fas fa-utensils" style="color:#e53935; margin-right:6px;"></i> ${item.name} x${item.quantity} — ₺${subtotal}<br>`;
  });
Swal.fire({
  title: '<i class="fas fa-receipt" style="color:#e53935;"></i> <strong>Siparişi Onayla</strong>',
  html: `
    <div style="text-align: left; font-size: 15px;">
      ${itemsText}
      <hr>
      <strong style="font-size: 17px;">Toplam: ₺${total}</strong><br><br>
      <i class="fas fa-user"></i> <strong>${name}</strong><br>
      <i class="fas fa-phone"></i> <strong>${phone}</strong><br>
      ${note ? `<i class="fas fa-sticky-note"></i> <em>${note}</em><br>` : ""}
    </div>
  `,
  icon: "question",
  background: "#fffef4",
  color: "#333",
  confirmButtonText: '<i class="fas fa-check-circle"></i> Onayla',
  cancelButtonText: '<i class="fas fa-times-circle"></i> İptal',
  showCancelButton: true,
  customClass: {
    confirmButton: 'esos-confirm-btn',
    cancelButton: 'esos-cancel-btn',
    popup: 'esos-popup'
  },
  showClass: {
    popup: "animate__animated animate__fadeInDown"
  },
  hideClass: {
    popup: "animate__animated animate__fadeOutUp"
  }
}).then((result) => {
  if (result.isConfirmed) {
    // ✅ Siparişi ver
    const now = new Date().toLocaleString();
    const orderData = {
      name,
      phone,
      note,
      items: selectedItems,
      date: now,
      status: "hazırlanıyor"
    };

    const orderRef = db.ref("orders").push();
    orderRef.set(orderData).then(() => {
      localStorage.setItem("orderKey", orderRef.key);
      Swal.fire({
        icon: 'success',
        title: '<i class="fas fa-check-circle" style="color:green;"></i> Sipariş Alındı!',
        text: 'Siparişiniz hazırlanıyor.'
      });
      listOwnOrder();
    });

  } else if (result.dismiss === Swal.DismissReason.cancel) {
    // ❌ İptal edildi
    Swal.fire({
      icon: "info",
      title: '<i class="fas fa-times-circle" style="color:#e74c3c;"></i> İptal Edildi',
      text: "Sipariş gönderilmedi."
    });
  }
});
  i.then((result) => {
    if (result.isConfirmed) {
      const now = new Date().toLocaleString();
      const orderData = {
        name,
        phone,
        note,
        items: selectedItems,
        date: now,
        status: "hazırlanıyor"
      };

      const orderRef = db.ref("orders").push();
      orderRef.set(orderData).then(() => {
        localStorage.setItem("orderKey", orderRef.key);
        Swal.fire({
          icon: 'success',
          title: '<i class="fas fa-check-circle" style="color:green;"></i> Sipariş Alındı!',
          text: 'Siparişiniz hazırlanıyor.'
        });
        listOwnOrder();
      }).catch((error) => {
        Swal.fire({
          icon: "error",
          title: "Hata Oluştu",
          text: "Sipariş gönderilemedi. Lütfen tekrar deneyin."
        });
        console.error("Firebase sipariş hatası:", error);
      });
    } else {
      Swal.fire({
  title: '<i class="fas fa-receipt" style="color:#b71c1c;"></i> <strong>Sepet Özeti</strong>',
  html: `
    <div style="text-align: left; font-size: 15px;">
      ${itemsText}
      <hr style="margin: 10px 0;">
      <strong style="font-size: 17px;">Toplam: ₺${total}</strong>
    </div>
  `,
  icon: "info",
  background: "#fff2f2",
  color: "#b71c1c",
  confirmButtonText: "Kapat",
  customClass: {
    popup: 'swal2-esos-popup',
    confirmButton: 'swal2-esos-btn'
  },
  showClass: {
    popup: "animate__animated animate__fadeInDown"
  },
  hideClass: {
    popup: "animate__animated animate__fadeOutUp"
  }
});
    }
  });
}

    // Siparişi listele
    const statusDiv = document.getElementById("order-status");

    function listOwnOrder() {
      const myOrderKey = localStorage.getItem("orderKey");
      if (!myOrderKey) {
        statusDiv.innerHTML = "<em>Henüz sipariş vermediniz.</em>";
        return;
      }

      db.ref("orders/" + myOrderKey).on("value", (snapshot) => {
        if (!snapshot.exists()) {
          statusDiv.innerHTML = "<em>Siparişiniz bulunamadı.</em>";
          return;
        }

        const order = snapshot.val();
        let itemsText = "";
        let total = 0;
// Eğer sipariş onaylandıysa ve daha önce uyarı gösterilmediyse
if (order.status === "onaylandı") {
  Swal.fire({
    icon: 'success',
    title: '✅ Siparişiniz Hazır!',
    text: 'Kasaya gelip teslim alabilirsiniz.',
    confirmButtonText: 'Tamam',
    allowOutsideClick: false,
    allowEscapeKey: false
  });
}

        order.items.forEach(item => {
          const subtotal = item.price * item.quantity;
          total += subtotal;
          itemsText += `• ${item.name} x${item.quantity} - ₺${subtotal}<br>`;
        });

        const noteText = order.note ? `<br><strong>Not:</strong> ${order.note}` : "";
        let status = "";

if (order.status === "onaylandı") {
  status = "<span style='color:#4caf50;font-weight:bold;'><i class='fas fa-check-circle'></i> Siparişiniz Hazır</span>";
} else if (order.status === "iptal") {
  status = "<span style='color:#e74c3c;font-weight:bold;'><i class='fas fa-times-circle'></i> Sipariş İptal Edildi</span>";
} else {
  status = "<span style='color:#e53935;'><i class='fas fa-spinner fa-spin'></i> Hazırlanıyor...</span>";
}

        let cancelButtonHTML = "";

if (order.status === "hazırlanıyor") {
  cancelButtonHTML = `<button onclick="showCancelConfirm('${myOrderKey}')" style="margin-top:10px; padding:8px 15px; background:#c0392b; color:white; border:none; border-radius:6px; cursor:pointer;"><i class="fas fa-ban"></i> İptal Et</button>`;
}

statusDiv.innerHTML = `
  <div class="order-box">
    <strong>${order.name} (${order.phone})</strong><br>
    ${itemsText}
    <strong>Toplam: ₺${total}</strong><br>
    <em>${order.date}</em>${noteText}<br>
    ${status}<br>
    ${cancelButtonHTML}
  </div>
`;
      });
    }

    window.onload = listOwnOrder;

  </script>
<script>
  function showCart() {
  const selectedItems = [];
  let total = 0;
  let itemsHTML = "";

  document.querySelectorAll("input[type=checkbox]:checked").forEach((checkbox) => {
    const key = checkbox.id.replace("item-", "");
    const itemName = checkbox.value;
    const itemPrice = parseFloat(checkbox.dataset.price);
    const quantity = parseInt(document.getElementById("qty-" + key).value || "1");
    const subtotal = itemPrice * quantity;
    total += subtotal;

    selectedItems.push({ name: itemName, price: itemPrice, quantity });
    itemsHTML += `<i class="fas fa-utensils" style="color:#e53935; margin-right:6px;"></i> ${itemName} x${quantity} — ₺${subtotal}<br>`;
  });

  if (selectedItems.length === 0) {
    Swal.fire({
      icon: "info",
      title: '<i class="fas fa-info-circle" style="color:red;"></i> Sepet Boş',
      text: "Henüz ürün seçmediniz.",
      confirmButtonText: "Tamam"
    });
    return;
  }

  Swal.fire({
  customClass: {
    confirmButton: 'sepet-kapat-btn',  // sadece bu popup için özel kapat butonu
    popup: 'esos-popup'
  },
  title: '<i class="fas fa-receipt" style="color:#e53935;"></i> <strong>Sepet Özeti</strong>',
  html: `
    <div style="text-align: left; font-size: 16px;">
      ${itemsHTML}
      <hr style="margin: 10px 0;">
      <strong style="font-size: 18px;">Toplam: ₺${total}</strong>
    </div>
  `,
  icon: 'info',
  background: "#fffbe6",
  color: "#444",
  showCancelButton: false, // sadece tek buton (kapat)
  confirmButtonText: "Kapat"
});
}
  function showCancelConfirm(orderId) {
    Swal.fire({
      title: 'Siparişi İptal Et',
      text: "Bu siparişi iptal etmek istediğinizden emin misiniz?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#c0392b',
      cancelButtonColor: '#aaa',
      confirmButtonText: 'Evet, iptal et',
      cancelButtonText: 'Vazgeç'
    }).then((result) => {
      if (result.isConfirmed) {
        firebase.database().ref("orders/" + orderId).update({
          status: "iptal"
        }).then(() => {
          Swal.fire(
            'İptal Edildi',
            'Sipariş başarıyla iptal edildi.',
            'success'
          );
          listOwnOrder();
        }).catch((error) => {
          Swal.fire(
            'Hata',
            'Sipariş iptal edilemedi.',
            'error'
          );
          console.error("İptal hatası:", error);
        });
      }
    });
  }

window.addEventListener("load", () => {
  const bugun = new Date().toISOString().split('T')[0];

  firebase.database().ref("gununMenusu/" + bugun).on("value", (snapshot) => {
  const data = snapshot.val();
  if (data) {
    const items = data.aciklama.split(",").map(item => item.trim());
    const listeHTML = items.map(item => `
      <li><i class="fas fa-utensils" style="color:#e74c3c;"></i> ${item}</li>
    `).join("");

    document.getElementById("gununMenusu").innerHTML = `
      <h3><i class="fas fa-concierge-bell"></i> ${data.baslik}</h3>
      <ul>${listeHTML}</ul>
    `;
  } else {
    document.getElementById("gununMenusu").innerHTML = `
      <p><i class="fas fa-info-circle"></i> Bugün için menü girilmemiş.</p>`;
  }
});

});
</script>
</script>
</body>
</html>
